블록체인을 사용한 디파이 프로젝트 렌드에프닷미가 ‘재진입 공격’을 받아 보관된 암호화폐 자금의 99.9%가량이 도난당하는 사고가 지난달 19일 발생했다./n 유니스왑 프로젝트에서도 유사한 재진입 공격으로 1278ETH이 갈취당했다./n 재진입 공격은 이더리움의 탈중앙화자율조직 ‘더다오’의 펀딩자금 1억 5천만달러를 빼내는데 사용된 공격으로도 유명하다./n렌드에프닷미를 공격한 해커는 갈취한 토큰을 암호화폐 거래소로 옮기려 시도했는데 수상한 거래를 탐지한 암호화폐 거래소가 경찰에 신고하면서 자신의 IP가 결국 발각됐다./n 이후 해커는 토큰 대부분을 렌드에프닷미에 반환했다./n 렌드에프닷미는 디파이 컨트랙트를 중지해 폐기했고 보안성을 높인 컨트랙트를 새로 배포할 예정이다./n 재진입 공격이 발생하는 이유와 재진입 공격을 막기 위한 방법을 블록체인 전문 보안감사 회사인 해치랩스로부터 들어봤다./n이더리움의 스마트 컨트랙트는 디앱의 비즈니스 로직을 구성하는 코드다./n 컨트랙트에선 사용자의 토큰 등 펀딩 자금이 코드를 통해 자동적으로 관리된다./n 디파이는 금융서비스를 컨트랙트로 구현한 프로젝트다./n 이더리움 스마트 컨트랙트는 필요한 경우 다른 컨트랙트를 호출해 여러 서비스를 사용할 수 있다./n 이같은 컨트랙트 간 호출 기능은 서로 다른 컨트랙트의 기능을 연동할 수 있는 장점이 있지만 보안상 취약점으로 작용할 수도 있다./n 재진입 공격도 컨트랙트가 외부 컨트랙트를 호출할 수 있다는 점을 악용해 발생한다./n특히 컨트랙트는 외부로부터 토큰이 도착하면 컨트랙트에 존재하는 함수가 자동적으로 실행되는 특성이 있어 주의가 필요하다./n 디파이 컨트랙트가 알려지지 않은 컨트랙트에 토큰을 전송하는 경우 악성 함수가 컨트랙트를 역으로 호출하는 공격을 받을 수 있다./n 이는 공격자 컨트랙트에서 실행된 함수가 디파이 컨트랙트에 역으로 진입해 인출을 무제한으로 명령하는 등 금융 사고다./n 한편 재진입 문제는 디파이 컨트랙트가 메타마스크 등 개인 지갑으로 생성한 사용자에게 토큰을 전송하는 경우엔 발생하지 않는다./n  구체적으로 살펴보면 렌드에프닷미 해킹 사태에선 해커가 먼저 1사토시를 디파이 컨트랙트에 예치했다./n 해커는 자신이 구현한 악성 컨트랙트 주소로 1사토시를 인출 받으려 시도했다./n 악성 컨트랙트에 1사토시가 도착하면서 공격 함수가 실행됐고 공격 함수는 기존의 전송 명령어를 하이재킹해 인출량을 변경시켰다./n 이같은 공격으로 해커는 자신이 보유한 프로젝트 토큰의 양을 총 290토큰까지 늘렸다./n 해커는 이처럼 위조한 토큰으로 렌드에프닷미에 존재하는 암호화폐를 모두 대출해 디파이 자금을 대부분 빼돌렸다./n 렌드에프닷미는 2천500만달러 상당의 금전피해를 입었다./n렌드에프닷미와 유니스왑 해킹 사태에선 해당 디파이 프로젝트 모두가 프로젝트 토큰으로 ERC-777 규격을 채택했다는 점도 보안 취약점으로 분석된다./n 이더리움 블록체인엔 토큰을 설계하는 표준 아키텍처가 있는데 이를 ERC+숫자 형태로 표현한다./n ERC-777은 기존 ERC-20의 사용자 경험을 개선하기 위해 기능을 업그레이드한 상위 버전의 토큰 표준 규격이다./n ERC-20은 호환성이 높아 이더리움 기반의 프로젝트 중 대다수가 현재 채택하고 있지만 전송한 토큰이 상대방에게 제대로 도착했는지 알 수 없어 불편한 단점이 있다./n 이를 개선하고자 ERC-20을 발전시킨 ERC-777이 개발됐다./n ERC-777 규격에선 ERC-20 토큰을 전송하는 기존 기능에 특수한 로직인 ‘후크’가 추가돼 토큰 수신 내역, 전송 내역을 검증 할 수 있게 개선했다./n 후크가 탑재되면서 ERC-777 토큰은 ‘폴백 기능’을 이더리움 코인 수준으로 구현할 수 있게 됐다./n 폴백이란 토큰이 외부 컨트랙트에 도착한 경우 이름없는 간단한 함수가 실행돼 ‘토큰이 제대로 도착했음’과 같은 수신확인을 표시하는 하는 기능이다./n 후크는 간편하고 UX 개선의 효과가 있지만 주의 없이 쓰면 악성 공격이 침입하는 ‘백도어’로 활용될 여지도 항상 존재한다./n 디파이 컨트랙트의 토큰 수신자가 악성 컨트랙트일 경우 폴백 기능안에 공격 코드를 심어둬 재진입 공격을 가할 수 있기 때문이다./n 이는 사용의 편리함과 교환한 트레이드오프인 셈이다./n 그렇다고 디파이 프로젝트가 수신자 타입을 미리 분별해 토큰 전송을 금지할 방법은 아직 없다./n 디파이 토큰을 수신하는 주소가 메타마스크 등 개인 지갑을 사용해 생성한 사용자 개인 계정의 주소인지 혹은 코드로 배포된 컨트랙트의 주소인지 분간할 방법이 현재 없기 때문이다./n 때문에 컨트랙트에서 ERC-777 토큰을 전송하는 기능은 위험성을 항상 내포한다./n 블록체인 보안전문기업 팩실드는 자사 블로그를 통해 “ERC-20과 ERC-777 사이에서 사용자의 보안성을 위해 토큰 규격을 다시 선택하는 고민이 필요하다./n ERC-777로 설계된 토큰은 재진입 공격을 당할 우려가 있다”고 경고했다./n 컨트랙트의 보안성을 심각하게 고려하지 않는 대다수의 경우 ERC-777 사용으로 인한 피해가 발생할 수 있다고 팩실드는 분석한다./n 반면 최지혁 해치랩스 개발자는 “렌드에프닷미 사태는 ERC-777 자체의 결함이 아니라 외부 컨트랙트가 그저 안전할 것으로 가정하고 탈중앙화금융 컨트랙트를 설계해 발생한 사고”라고 분석한다./n 그는 2016년 발생한 더다오 자금 해킹 사태도 이더리움 블록체인 자체의 문제라기보단 당시 컨트랙트 로직의 문제가 컸던 만큼 컨트랙트를 설계할 때 항상 주의해야 한다고 덧붙였다./n 실제로 이더리움 개발 회사 컨센시스와 오픈제플린은 컨트랙트에서 여러 토큰을 전송할 때 과정상 재진입 공격의 가능성이 항상 있음을 밝히며 컨트랙트를 설계하는 데 있어 주의할 것을 미리 당부한 바 있다./n해커가 자금을 갈취하는 재진입 문제를 해결할 ‘안티 패턴’도 존재한다./n 소프트웨어 공학에서 어떤 문제를 푸는 검증되고 유용한 해법을 패턴이라고 한다./n 최 개발자는 이러한 안티 패턴 중에서 특히 ‘체크 이펙트 인터렉션’ 패턴은 디파이 코드를 구현할 때 필수적이라고 설명했다./n 이는 토큰 전송 등 비즈니스 로직을 코드로 구현할 때 토큰 전송함수를 잔고 업데이트 함수보다 뒤에 위치시키는 패턴이다./n 예를 들어 10토큰을 전송하는 경우 컨트랙트는 먼저 사용자의 잔고에서 -10한 결과값을 먼저 상태로 업데이트한 뒤 토큰을 실제적으로 전송하는 방식이다./n 이같은 방식을 코드에 적용하면 토큰의 무제한 인출 사태를 방지할 수 있어 효과적이다./n 또 재진입 공격을 막는 가드를 추가하는 ‘뮤텍스’ 패턴, ‘풀 페이먼트’를 통해 토큰을 전송하는 패턴도 효과적이다./n 이밖에도 알려지지 않은 컨트랙트에 토큰을 전송할 때 이더리움의 기본 내장함수를 사용하는 방식도 권장된다./n 기본 내장함수인 트랜스퍼는 토큰을 전송할 때 가스량을 제한하기 때문에 재진입 공격을 발생시키는 호출 행위를 애초에 방지할 수 있는 효과가 있기 때문이다./n최지혁 해치랩스 개발자는 “이번 유니스왑, 렌드에프닷미에 발생한 재진입 공격도 외부 컨트랙트, 함수가 그저 안전할 것이라 예상하고 작성한 개발자의 부주의가 큰 이유다./n 컨트랙트가 외부 함수를 호출할 수 있는 경우가 많기에 더욱 방어적으로 개발해야 할 것”이라고 말했다./n 실제로 민다오 양 렌드에프닷미 최고경영자도 컨트랙트 개발에 부주의한 실수가 발견됐다고 블로그 글을 통해 최근 시인한 바 있다./n 이에 최 개발자는 “특히 디파이 컨트랙트와 같이 외부 컨트랙트와 상호작용이 많은 경우 더욱 조심해야 한다”고 덧붙였다./n 최 개발자는 “보안감사를 진행하다 보면 이같은 스마트 컨트랙트상 보안 취약점을 가진 팀을 종종 만난다./n 컨트랙트를 안전하고 완벽하게 작성하는 건 쉽지 않아 개발자의 주의가 항상 필요한데 정식 서비스를 런칭하기 전 반드시 보안 전문가를 통해 보안 감사를 받아보길 권유한다”고 말했다.